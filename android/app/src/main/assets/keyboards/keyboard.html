<!--
  ~ Copyright (c) 2023 Fime project https://fime.fit
  ~ Initial author: zelde126@126.com
  -->

<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="fime.css">
    <style>
        /* your css here */
        .key-shift .fime-label:before {
            content: "\e90a";
        }

        .key-shift-fill .fime-label:before {
            content: "\e90b";
        }

        .key-backspace .fime-label:before {
            content: "\e902";
        }

        .key-enter .fime-label:before {
            content: "\e900";
        }

        .key-return .fime-label:before {
            content: "\e909";
        }
    </style>
    <title>Keyboard</title>
</head>

<body class="fime-box clearfix icon-fime">
    <div class="fime-kbd-box" data-layout="qwerty">
        <div class="fime-key-row">
            <div class="fime-key">
                <span class="fime-symbol">1</span>
                <span class="fime-label">q</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">2</span>
                <span class="fime-label">w</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">3</span>
                <span class="fime-label">e</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">4</span>
                <span class="fime-label">r</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">5</span>
                <span class="fime-label">t</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">6</span>
                <span class="fime-label">y</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">7</span>
                <span class="fime-label">u</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">8</span>
                <span class="fime-label">i</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">9</span>
                <span class="fime-label">o</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">0</span>
                <span class="fime-label">p</span>
            </div>
        </div>
        <div class="fime-key-row">
            <div class="fime-box">
                &emsp;
            </div>
            <span class="fime-key">
                <span class="fime-symbol">!</span>
                <span class="fime-label">a</span>
            </span>
            <span class="fime-key">
                <span class="fime-symbol">@</span>
                <span class="fime-label">s</span>
            </span>
            <span class="fime-key">
                <span class="fime-symbol">#</span>
                <span class="fime-label">d</span>
            </span>
            <span class="fime-key">
                <span class="fime-symbol">$</span>
                <span class="fime-label">f</span>
            </span>
            <span class="fime-key">
                <span class="fime-symbol">%</span>
                <span class="fime-label">g</span>
            </span>
            <span class="fime-key">
                <span class="fime-symbol">^</span>
                <span class="fime-label">h</span>
            </span>
            <span class="fime-key">
                <span class="fime-symbol">&</span>
                <span class="fime-label">j</span>
            </span>
            <span class="fime-key">
                <span class="fime-symbol">*</span>
                <span class="fime-label">k</span>
            </span>
            <span class="fime-key">
                <span class="fime-symbol">\</span>
                <span class="fime-label">l</span>
            </span>
            <div class="fime-box">
                &emsp;
            </div>
        </div>
        <div class="fime-key-row">
            <div class="fime-key fime-fnkey key-shift">
                <span class="fime-label"></span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">(</span>
                <span class="fime-label">z</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">)</span>
                <span class="fime-label">x</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">[</span>
                <span class="fime-label">c</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">]</span>
                <span class="fime-label">v</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">{</span>
                <span class="fime-label">b</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">}</span>
                <span class="fime-label">n</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">/</span>
                <span class="fime-label">m</span>
            </div>
            <div class="fime-key fime-fnkey key-backspace">
                <span class="fime-label"></span>
            </div>
        </div>
        <div class="fime-key-row">
            <div class="fime-key fime-fnkey">
                <span class="fime-label">En</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">;</span>
                <span class="fime-label">'</span>
            </div>
            <div class="fime-key" style="width: 300%;" data-name="VK_SPACE">
                <span class="fime-label">Fime</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">,</span>
                <span class="fime-label">，</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">.</span>
                <span class="fime-label">。</span>
            </div>
            <div class="fime-key fime-fnkey key-enter">
                <span class="fime-label"></span>
            </div>
        </div>
    </div>

    <div class="fime-kbd-box" data-layout="abc">
        <div class="fime-key-row">
            <div class="fime-key">
                <span class="fime-symbol">1</span>
                <span class="fime-label">q</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">2</span>
                <span class="fime-label">w</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">3</span>
                <span class="fime-label">e</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">4</span>
                <span class="fime-label">r</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">5</span>
                <span class="fime-label">t</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">6</span>
                <span class="fime-label">y</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">7</span>
                <span class="fime-label">u</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">8</span>
                <span class="fime-label">i</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">9</span>
                <span class="fime-label">o</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">0</span>
                <span class="fime-label">p</span>
            </div>
        </div>
        <div class="fime-key-row">
            <div class="fime-box">
                &emsp;
            </div>
            <span class="fime-key">
                <span class="fime-symbol">!</span>
                <span class="fime-label">a</span>
            </span>
            <span class="fime-key">
                <span class="fime-symbol">@</span>
                <span class="fime-label">s</span>
            </span>
            <span class="fime-key">
                <span class="fime-symbol">#</span>
                <span class="fime-label">d</span>
            </span>
            <span class="fime-key">
                <span class="fime-symbol">$</span>
                <span class="fime-label">f</span>
            </span>
            <span class="fime-key">
                <span class="fime-symbol">%</span>
                <span class="fime-label">g</span>
            </span>
            <span class="fime-key">
                <span class="fime-symbol">^</span>
                <span class="fime-label">h</span>
            </span>
            <span class="fime-key">
                <span class="fime-symbol">&</span>
                <span class="fime-label">j</span>
            </span>
            <span class="fime-key">
                <span class="fime-symbol">*</span>
                <span class="fime-label">k</span>
            </span>
            <span class="fime-key">
                <span class="fime-symbol">\</span>
                <span class="fime-label">l</span>
            </span>
            <div class="fime-box">
                &emsp;
            </div>
        </div>
        <div class="fime-key-row">
            <div class="fime-key fime-fnkey key-shift">
                <span class="fime-label"></span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">(</span>
                <span class="fime-label">z</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">)</span>
                <span class="fime-label">x</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">[</span>
                <span class="fime-label">c</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">]</span>
                <span class="fime-label">v</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">{</span>
                <span class="fime-label">b</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">}</span>
                <span class="fime-label">n</span>
            </div>
            <div class="fime-key">
                <span class="fime-symbol">/</span>
                <span class="fime-label">m</span>
            </div>
            <div class="fime-key fime-fnkey key-backspace">
                <span class="fime-label"></span>
            </div>
        </div>
        <div class="fime-key-row">
            <div class="fime-key fime-fnkey">
                <span class="fime-label">123</span>
            </div>
            <div class="fime-key fime-fnkey key-return">
                <span class="fime-label"></span>
            </div>
            <div class="fime-key" style="width: 300%;">
                <span class="fime-label">Space</span>
            </div>
            <div class="fime-key fime-fnkey">
                <span class="fime-label">¥</span>
            </div>
            <div class="fime-key fime-fnkey key-enter">
                <span class="fime-label"></span>
            </div>
        </div>
    </div>

    <div class="fime-kbd-box" data-layout="digital">
        <div class="fime-key-row">
            <div class="fime-key-box fime-key-col" style="width: 12%; height: 144px;">
                <div class="fime-key fime-fnkey" style="border-radius:0; border-bottom: 1px solid #aaadb4;">
                    <span class="fime-label" style="line-height: 30px;">，</span>
                </div>
                <div class="fime-key fime-fnkey" style="border-radius:0; border-bottom: 1px solid #aaadb4;">
                    <span class="fime-label" style="line-height: 30px;">。</span>
                </div>
                <div class="fime-key fime-fnkey" style="border-radius:0; border-bottom: 1px solid #aaadb4;">
                    <span class="fime-label" style="line-height: 30px;">？</span>
                </div>
                <div class="fime-key fime-fnkey" style="border-radius:0; border-bottom: 1px solid #aaadb4;">
                    <span class="fime-label" style="line-height: 30px;">！</span>
                </div>
            </div>
            <div>&nbsp;</div>
            <div class="fime-key" style="width: 20%;">
                <span class="fime-label">1</span>
            </div>
            <div class="fime-key" style="width: 20%;">
                <span class="fime-label">2</span>
            </div>
            <div class="fime-key" style="width: 20%;">
                <span class="fime-label">3</span>
            </div>
            <div class="fime-key fime-fnkey key-backspace" style="width: 8%;">
                <span class="fime-label"></span>
            </div>
        </div>
        <div class="fime-key-row">
            <div class="fime-key-col" style="width: 12%;">&emsp;</div>
            <div>&nbsp;</div>
            <div class="fime-key" style="width: 20%;">
                <span class="fime-label">4</span>
            </div>
            <div class="fime-key" style="width: 20%;">
                <span class="fime-label">5</span>
            </div>
            <div class="fime-key" style="width: 20%;">
                <span class="fime-label">6</span>
            </div>
            <div class="fime-key fime-fnkey key-enter" style="width: 8%;">
                <span class="fime-label"></span>
            </div>
        </div>
        <div class="fime-key-row">
            <div class="fime-key-col" style="width: 12%;">&emsp;</div>
            <div>&nbsp;</div>
            <div class="fime-key" style="width: 20%;">
                <span class="fime-label">7</span>
            </div>
            <div class="fime-key" style="width: 20%;">
                <span class="fime-label">8</span>
            </div>
            <div class="fime-key" style="width: 20%;">
                <span class="fime-label">9</span>
            </div>
            <div class="fime-key fime-fnkey" style="width: 8%;">
                <span class="fime-label">¥</span>
            </div>
        </div>
        <div class="fime-key-row">
            <div class="fime-key fime-fnkey key-return" style="width: 8%;">
                <span class="fime-label"></span>
            </div>
            <div class="fime-key" style="width: 15%;">
                <span class="fime-label">*</span>
            </div>
            <div class="fime-key" style="width: 20%;">
                <span class="fime-label">0</span>
            </div>
            <div class="fime-key" style="width: 15%;">
                <span class="fime-label">#</span>
            </div>
            <div class="fime-key fime-fnkey" style="width: 8%;">
                <span class="fime-label">En</span>
            </div>
        </div>
    </div>

    <div class="fime-kbd-box" data-layout="symbol">
        <div class="fime-key-row">
            <div class="fime-key">
                <span class="fime-label">+</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">-</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">*</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">/</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">.</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">&</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">|</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">(</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">)</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">=</span>
            </div>
        </div>
        <div class="fime-key-row">
            <div class="fime-key">
                <span class="fime-label">±</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">[</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">]</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">{</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">}</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">&lt;</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">&gt;</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">≈</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">≠</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">#</span>
            </div>
        </div>
        <div class="fime-key-row">
            <div class="fime-key">
                <span class="fime-label">@</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">¥</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">$</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">%</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">÷</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">°</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">©</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">®</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">≤</span>
            </div>
            <div class="fime-key">
                <span class="fime-label">≥</span>
            </div>
        </div>
        <div class="fime-key-row">
            <div class="fime-key fime-fnkey">
                <span class="fime-label">123</span>
            </div>
            <div class="fime-key fime-fnkey key-return">
                <span class="fime-label"></span>
            </div>
            <div class="fime-key fime-fnkey">
                <span class="fime-label">En</span>
            </div>
            <div class="fime-key fime-fnkey key-backspace">
                <span class="fime-label"></span>
            </div>
            <div class="fime-key fime-fnkey key-enter">
                <span class="fime-label"></span>
            </div>
        </div>
    </div>

    <script src="any-touch.umd.min.js"></script>
    <script src="fime.js"></script>
    <script>
        const CN_MODE = 1
        const EN_MODE = 0

        const ESC = 'VK_FN_ESC'
        const TAB = 'VK_FN_TAB'
        const SHIFT = 'VK_FN_SHIFT'
        const CTRL = 'VK_FN_CTRL'
        const ALT = 'VK_FN_ALT'
        const BACKSPACE = 'VK_FN_BACKSPACE'
        const DELETE = 'VK_FN_DELETE'
        const HOME = 'VK_FN_HOME'
        const END = 'VK_FN_END'
        const PAGE_UP = 'VK_FN_PAGE_UP'
        const PAGE_DOWN = 'VK_FN_PAGE_DOWN'
        const ENTER = 'VK_FN_ENTER'
        const CLEAR = 'VK_FN_CLEAR'
        const CAPS_LOCK = 'VK_FN_CAPS_LOCK'
        const LEFT = 'VK_FN_LEFT'
        const UP = 'VK_FN_UP'
        const RIGHT = 'VK_FN_RIGHT'
        const DOWN = 'VK_FN_DOWN'
        const ABC = 'VK_FN_ABC'
        const DIGITAL = 'VK_FN_123'
        const SYMBOL = 'VK_FN_SYMBOL'
        const RETURN = 'VK_FN_RETURN'
        const SPACE = 'VK_SPACE'
        const SINGLE_QUOTE = 'VK_SINGLE_QUOTE'

        const REG_ALPHABET = new RegExp("^[a-zA-Z]$")

        const layouts = fime.qsa('.fime-kbd-box')
        let defaultLayout = 'qwerty'
        let activeLayout = ''
        let shifted = false
        let longPressCheck = false
        const LONG_PRESS_INTERVAL = 100


        switchLayout(defaultLayout)
        !(function () {
            fime.qsa('.fime-fnkey').forEach(el => {
                if (el.classList.contains('key-shift')) {
                    el.dataset.name = SHIFT
                } else if (el.classList.contains('key-backspace')) {
                    el.dataset.name = BACKSPACE
                } else if (el.classList.contains('key-enter')) {
                    el.dataset.name = ENTER
                } else if (el.classList.contains('key-space')) {
                    el.dataset.name = SPACE
                } else if (el.classList.contains('key-return')) {
                    el.dataset.name = RETURN
                }
            })
        })();

        let at = new AnyTouch(fime.qs('.fime-box'))
        at.on(['at:start', 'at:end', 'tap', 'panend', 'press'], function (e) {
            let info = [e.type, e.name, e.phase, '@', e.target.tagName]
            // console.log(info.join(' '))
            let t = e.target
            if (e.target.tagName != 'DIV') t = e.target.parentNode
            let name = t.dataset.name || t.querySelector('span.fime-label').innerHTML
            t.classList.add('fime-key-active')
            if (e.type == 'at:start') {
                longPressCheck = true
                setTimeout(function () { if (longPressCheck) startLongPress(name) }, 150)
            } else if (e.type == 'tap') {
                longPressCheck = false
                onTap(name)
            } else if (e.type == 'panend') {
                longPressCheck = false
                let s = t.querySelector('span.fime-symbol')
                if (s && e.direction == 'up') {
                    onTap(s.innerHTML)
                }
            } else if (e.type == 'press') {
                onTap(name)
            }
            if (e.isEnd) {
                longPressCheck = false
                setTimeout(function () { t.classList.remove('fime-key-active') }, 200)
            }
        })

        function toggleShift() {
            setShift(!shifted)
        }

        function setShift(state) {
            if (shifted == state) return
            shifted = state
            let layout = fime.qs('[data-layout="' + activeLayout + '"]')
            let shift = layout.querySelector('[data-name="' + SHIFT + '"]')
            if (!shift) return  // shift key not found

            if (shifted) {
                shift.classList.remove('key-shift')
                shift.classList.add('key-shift-fill')
                layout.querySelectorAll('.fime-label').forEach(el => {
                    if (REG_ALPHABET.test(el.innerHTML)) el.innerHTML = el.innerHTML.toUpperCase()
                })
            } else {
                shift.classList.remove('key-shift-fill')
                shift.classList.add('key-shift')
                layout.querySelectorAll('.fime-label').forEach(el => {
                    if (REG_ALPHABET.test(el.innerHTML)) el.innerHTML = el.innerHTML.toLowerCase()
                })
            }
        }

        function startLongPress(name) {
            let timer = setInterval(() => {
                // console.log('longPressCheck=' + longPressCheck)
                if (longPressCheck) {
                    onTap(name)
                } else {
                    clearInterval(timer)
                }
            }, LONG_PRESS_INTERVAL)
        }

        function onTap(name) {
            // console.log('on key: ' + name)
            if (name == SHIFT) {
                toggleShift()
            } else if (name == 'En') {
                switchLayout('abc')
                fime.setMode(EN_MODE)
            } else if (name == '123' || name == DIGITAL) {
                switchLayout('digital')
                fime.setMode(EN_MODE)
            } else if (name == RETURN) {
                switchLayout(defaultLayout)
                fime.setMode(CN_MODE)
            } else if (name == '¥' || name == SYMBOL) {
                switchLayout('symbol')
                fime.setMode(EN_MODE)
            } else if (name == 'Space' || name == SPACE) {
                fime.onKey(SPACE)
            } else if (name == BACKSPACE) {
                fime.onKey(BACKSPACE)
            } else if (name == ENTER) {
                fime.onKey(ENTER)
            } else if (name == "'" || name == SINGLE_QUOTE) {
                fime.onKey(SINGLE_QUOTE)
            } else {
                fime.onKey(name)
            }
        }

        function onSwipe(symbol) {
            console.log('on swipe: ' + symbol)
        }

        function switchLayout(layout) {
            if (activeLayout == layout) return
            console.log('switchLayout:' + layout)
            layouts.forEach(l => {
                l.style.display = l.dataset.layout == layout ? '' : 'none'
            })
            activeLayout = layout
            setShift(false)
        }

        fime.callNative('getDefaultLayout', {}, function (args) {
            defaultLayout = args['default-layout']
            switchLayout(defaultLayout)
        })

        fime.addListener('onKeyboardLayout', function (json) {
            switchLayout(json.layout)
        })
    </script>
</body>

</html>